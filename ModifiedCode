
#include <Wire.h>
// Date and time functions using a DS3231 RTC connected via I2C
#include "RTClib_Tig.h"
//SD card communicates through SPI using library SdFat
#include <SPI.h>
#include <SdFat.h>
//Thermocouple library for Max31855
#include "Adafruit_MAX31855.h"
//ADC library for ADS1115, 16-bit and 4 channel (we use one here) connected via I2C
#include <Adafruit_ADS1015.h>
//To create software serial to communicate with the DO probe by RS232
#include <SoftwareSerial.h>

/*  GLOBAL VARIABLES  */
RTC_DS3231 rtc; // Real-time clock
SdFat sd; //SD card
SdFile myFile; //file to manipulate on SD
const int sdCS = 10; //CS is pin 10 for SD handling
Adafruit_ADS1115 adc; //ADC chip
int Model;
int SerialNum;
float DOmgLSet;
SoftwareSerial doProbe(9,8); // RX, TX lines, Dissolved Oxygen probe

Adafruit_MAX31855 thermocouple(5, 6, 7);

const int milliDelay = 2000; //delay time between readings in milliseconds
bool serialEcho = 1; //1 to write information to Serial for troubleshooting
                     //0 to supress

//gas control
const int O2valve = 2;

const int N2valve = 3;

const int CO2valve = 4;

////    SET-UP   ////

void setup() {
  Serial.begin(4800); //communicates with computer via Serial port
  doProbe.begin(9600); //communicates with DO probe
  pinMode(O2valve, OUTPUT); //control pin for O2 solenoid valve
  pinMode(N2valve, OUTPUT); //control pin for O2 solenoid valve
  pinMode(CO2valve, OUTPUT); //control pin for O2 solenoid valve

  delay(2000); // wait for console opening
  if (serialEcho) {
    Serial.println("Commencing set up...");
  }

  /*  Set-up RTC  */
  //if RTC is unresponsive, code enters indefinite loop, does not continue "loop"
  if (! rtc.begin()) {
    Serial.println("couldn't find RTC, stopping set-up.");
    while (1); 
  }

  //Test removing once battery is added
  DateTime compileTime = DateTime(F(__DATE__), F(__TIME__));
  rtc.adjust(compileTime); //remove once battery added
  Serial.println("");
  Serial.print("setting RTC to compile time:\t");
  printTimeToSerial(compileTime);
  
  if (rtc.lostPower()) {
    Serial.println("RTC lost power, lets set the time!");
    // following line sets the RTC to the date & time this sketch was compiled
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  }
  if (serialEcho) {
    Serial.println(", rtc set up...");
  }

  if (!sd.begin(sdCS, SPI_HALF_SPEED)) {
    sd.initErrorHalt();
  }
  if (serialEcho) {
    Serial.println("SD card set up...");
  }
  //Delete current test.txt file if present
  if (sd.exists("test.txt")) {
    sd.remove("test.txt");
  }
  //Start file and print header line
  if (!myFile.open("test.txt", O_RDWR | O_CREAT | O_AT_END)) {
    sd.errorHalt("opening test.txt for write failed");
  }
  myFile.println ("date \t time \t temp_degC \t pH_rawV \t O2_mgL");
  //myFile.close();

  /*  Set-up ADC  */
  adc.begin();
  adc.setGain(GAIN_ONE);

  /*  Begin reading DO Probe  */
  Serial.println("Beginning reading...");
  WaitforSerialChar('M');

  /*  Set-up complete */
  if (serialEcho) {
    Serial.println("set up complete.");
  }
}

////    LOOP   ////
void loop() {
  DateTime curr = rtc.now();
  unsigned long milli = millis();
  unsigned long milli2 = millis();
  int milliInt = (int)milli;
  
  if (serialEcho) {
    printTimeToSerial (curr);
    printTimeToSD (curr);
  }


  double c = thermocouple.readCelsius();
   if (isnan(c)) {
     Serial.println("Something wrong with thermocouple!");
   } else {
     if (serialEcho) {
     printTempToSerial (c);
     printTempToSD(c);
     }
   }

  double phMeas = getpH();
  if(serialEcho) {
    printpHToSerial(phMeas);
    printpHToSD(phMeas);
  }
  
  // Read from O2 Probe
  double doMeas = getDOmgL(); //get DO measurement in mg/L
  if (serialEcho) {
    printDOmgLToSerial(doMeas);
    printDOmgLToSD(doMeas);
  }

Serial.println("    Begin");
  while ((milli - milli2) < 21600000) {
    if (getpH() > 6.99 && getpH() < 7.2 && getDOmgL() > 3.59 && getDOmgL() < 4.0) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(900);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 6.99 && getpH() < 7.2 && getDOmgL() > 3.99) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 6.99 && getpH() < 7.2 && getDOmgL() < 3.60) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(250);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(650);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.19 && getDOmgL() > 3.99) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(500);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(300);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.19 && getDOmgL() < 3.60) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(400);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(400);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.19) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7 && getDOmgL() < 3.60) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7 && getDOmgL() > 3.99) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(200);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(600);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
  }
  Serial.println();
  myFile.close();
  myFile.open("test.txt", O_RDWR | O_CREAT | O_AT_END);
  while ((milli - milli2) > 21599999 && (milli - milli2) < 43200000) {
    if (getpH() > 7.89 && getpH() < 8.10 && getDOmgL() > 8.29 && getDOmgL() < 8.60) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(900);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.89 && getpH() < 8.10 && getDOmgL() > 8.59) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.89 && getpH() < 8.10 && getDOmgL() < 8.30) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(250);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(650);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.09 && getDOmgL() > 8.59) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(500);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(300);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.09 && getDOmgL() < 8.30) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(400);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(400);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.09) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7.90 && getDOmgL() < 8.30) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7.90 && getDOmgL() > 8.59) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7.90) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(200);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(600);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
  }
  Serial.println();
  myFile.close();
  myFile.open("test.txt", O_RDWR | O_CREAT | O_AT_END);
  while ((milli - milli2) > 43199999 && (milli -milli2) < 64800000) {
    if (getpH() > 8.79 && getpH() < 9.00 && getDOmgL() > 13.89 && getDOmgL() < 14.20) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(900);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.79 && getpH() < 9.00 && getDOmgL() > 14.19) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.79 && getpH() < 9.00 && getDOmgL() < 13.90) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(250);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(650);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.99 && getDOmgL() > 14.19) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(500);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(300);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.99 && getDOmgL() < 13.90) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(400);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(400);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.99) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 8.80 && getDOmgL() < 13.90) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 8.80 && getDOmgL() > 14.19) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 8.80) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(200);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(600);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
  }
  Serial.println();
  myFile.close();
  myFile.open("test.txt", O_RDWR | O_CREAT | O_AT_END);
  while ((milli - milli2) > 64799999 && (milli - milli2) < 86400000) {
    if (getpH() > 7.89 && getpH() < 8.10 && getDOmgL() > 8.29 && getDOmgL() < 8.60) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(900);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.89 && getpH() < 8.10 && getDOmgL() > 8.59) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 7.89 && getpH() < 8.10 && getDOmgL() < 8.30) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(250);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(650);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      double c = thermocouple.readCelsius();
      double phMeas = getpH();
      double doMeas = getDOmgL();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.09 && getDOmgL() > 8.59) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(500);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(300);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.09 && getDOmgL() < 8.30) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(400);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(400);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() > 8.09) {
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, HIGH);
      digitalWrite(O2valve, LOW);
      delay(100);
      digitalWrite(N2valve, LOW);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(800);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7.90 && getDOmgL() < 8.30) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, HIGH);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7.90 && getDOmgL() > 8.59) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(450);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
    else if (getpH() < 7.90) {
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(200);
      digitalWrite(N2valve, HIGH);
      digitalWrite(CO2valve, LOW);
      digitalWrite(O2valve, LOW);
      delay(600);
      milli = millis();
      milliInt = (int)milli;
      DateTime curr = rtc.now();
      if (serialEcho) {
        printTimeToSerial (curr);
        printTimeToSD (curr);
      }
      double c = thermocouple.readCelsius();
      if (serialEcho) {
        printTempToSerial (c);
        printTempToSD(c);
      }
      double phMeas = getpH();
      if(serialEcho) {
        printpHToSerial(phMeas);
        printpHToSD(phMeas);
      }
      double doMeas = getDOmgL();
      if (serialEcho) {
        printDOmgLToSerial(doMeas);
        printDOmgLToSD(doMeas);
      }
      Serial.print(" ");
      Serial.print(milli);
      Serial.println(" ");
    }
  }
  milli2 = millis();
  myFile.close();
  myFile.open("test.txt", O_RDWR | O_CREAT | O_AT_END);
  
}

////    FUNCTIONS   ////

static void printTimeToSD (DateTime curr) {
  myFile.print(curr.year(), DEC);
  myFile.print('/');
  myFile.print(curr.month(), DEC);
  myFile.print('/');
  myFile.print(curr.day(), DEC);
  myFile.print('\t');
  myFile.print(curr.hour(), DEC);
  myFile.print(':');
  myFile.print(curr.minute(), DEC);
  myFile.print(':');
  myFile.print(curr.second(), DEC);
}

static void printTimeToSerial (DateTime curr) {
  Serial.print(curr.year(), DEC);
  Serial.print('/');
  Serial.print(curr.month(), DEC);
  Serial.print('/');
  Serial.print(curr.day(), DEC);
  Serial.print('\t');
  Serial.print(curr.hour(), DEC);
  Serial.print(':');
  Serial.print(curr.minute(), DEC);
  Serial.print(':');
  Serial.print(curr.second(), DEC);
}

static void printTempToSD (double temp) {
  myFile.print('\t');
  myFile.print(temp);
}

static void printTempToSerial (double temp) {
  Serial.print("\t C = ");
  Serial.print(temp);
}

static void printpHToSD (double pH) {
  myFile.print('\t');
  myFile.print("*");
  myFile.print(pH);
  myFile.print("*");
}

static void printpHToSerial (double pH) {
  Serial.print('\t');
  Serial.print("pH (V from ADC) = "); 
  Serial.print(pH);
}

static void printDOuMolToSD (double measure) {
  myFile.print("\t");
  myFile.print(measure);
}

static void printDOuMolToSerial (double measure) {
  Serial.print("\t DO (uMol) = ");
  Serial.print(measure);
}

static void printDOmgLToSD (double measure) {
  myFile.print("\t");
  myFile.print("-");
  myFile.println(measure);
  myFile.print("-");
}

static void printDOmgLToSerial (double measure) {
  Serial.print("\t DO (mg/L) = ");
  Serial.print(measure);
}

static double getpH () {
   int16_t pHRaw; //16-bit int dedicated to pH readings to be taken on A2
   pHRaw = adc.readADC_SingleEnded(2);
   double pHVolt = (pHRaw+2390.8)/3135.7; //with 1x gain 1 bit = 0.125mV
   return pHVolt;
}

void WaitforSerialChar(char start){
  char currChar = doProbe.read();
  while (currChar != (start)){
    currChar = doProbe.read();
  }
}

double getDOuMol(){
  WaitforSerialChar('M');
  doProbe.parseInt();
  doProbe.parseInt();
  float DOuMolMeas = doProbe.parseFloat();
}

double getDOmgL(){
  float DOuMolMeas = getDOuMol();
  float DOmgLMeas = DOuMolMeas*0.031998;  //convert uMol to mg/L
  return DOmgLMeas;
}
